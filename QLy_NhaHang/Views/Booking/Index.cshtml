@model QLy_NhaHang.ViewModels.TableSelectionViewModel
@{
    ViewData["Title"] = "Chọn Bàn - Rose Thảo Điền";
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css" asp-append-version="true" />
    <style>
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .table-card {
            aspect-ratio: 1;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table-card.available {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .table-card.available:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 15px rgba(40, 167, 69, 0.3);
            border-color: #fff;
        }

        .table-card.occupied {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .table-card.reserved {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .table-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .table-info {
            font-size: 0.9rem;
            text-align: center;
        }

        .table-status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 0.5rem;
        }

        .legend-color.available {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .legend-color.occupied {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .legend-color.reserved {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        /* Table Grid in Modal */
        .table-grid-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }

        .table-card-modal {
            aspect-ratio: 1;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table-card-modal.available {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .table-card-modal.available:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
            border-color: #fff;
        }

        .table-card-modal.occupied {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .table-card-modal.occupied:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.3);
            border-color: #fff;
        }

        .table-card-modal.reserved {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
        }

        .table-card-modal.reserved:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(255, 193, 7, 0.3);
            border-color: #fff;
        }

        .table-card-modal .table-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .table-card-modal .table-info {
            font-size: 0.8rem;
            text-align: center;
        }

        /* Menu Modal Styles */
        .menu-sidebar-modal {
            height: 100%;
            overflow-y: auto;
        }

        .menu-content-modal {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .menu-category-btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .menu-category-btn:hover {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        #menuModal .modal-dialog {
            max-width: 90%;
        }
        
        #menuModal .modal-body {
            max-height: 70vh;
        }
        
        .menu-category-btn.btn-outline-success.active {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }
        
        .menu-category-btn.btn-outline-success:hover {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }
    </style>
}

<div class="booking-container">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="display-5 fw-bold mb-3">Đặt Bàn Tại Nhà Hàng</h1>
                    <p class="text-muted lead mb-4">Vui lòng chọn bàn trống (màu xanh) để đặt bàn</p>
                    
                    <!-- Nút Xác nhận bàn -->
                    <div class="mb-4">
                        <button type="button" class="btn btn-primary btn-lg px-5" data-bs-toggle="modal" data-bs-target="#selectTableModal">
                            <i class="bi bi-check-circle-fill me-2"></i>Xác Nhận Đúng Bàn Bạn Ngồi
                        </button>
                    </div>
                    
                    <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-calendar-check text-primary" style="font-size: 1.5rem;"></i>
                            <span class="text-muted">Đặt bàn nhanh chóng</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-shield-check text-success" style="font-size: 1.5rem;"></i>
                            <span class="text-muted">Xác nhận ngay</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body p-4">
                        <label class="form-label fw-semibold mb-3 d-flex align-items-center">
                            <i class="bi bi-funnel-fill text-primary me-2" style="font-size: 1.25rem;"></i>
                            <span>Lọc theo trạng thái</span>
                        </label>
                        <div class="btn-group w-100" role="group">
                            <a asp-action="Index" asp-route-filter="all" 
                               class="btn @(Model.CurrentFilter == "all" ? "btn-primary" : "btn-outline-primary")">
                                <i class="bi bi-grid-3x3-gap me-1"></i>Tất cả
                            </a>
                            <a asp-action="Index" asp-route-filter="free" 
                               class="btn @(Model.CurrentFilter == "free" ? "btn-success" : "btn-outline-success")">
                                <i class="bi bi-circle-fill me-1"></i>Trống
                            </a>
                            <a asp-action="Index" asp-route-filter="occupied" 
                               class="btn @(Model.CurrentFilter == "occupied" ? "btn-danger" : "btn-outline-danger")">
                                <i class="bi bi-circle-fill me-1"></i>Có khách
                            </a>
                            <a asp-action="Index" asp-route-filter="reserved" 
                               class="btn @(Model.CurrentFilter == "reserved" ? "btn-warning" : "btn-outline-warning")">
                                <i class="bi bi-circle-fill me-1"></i>Đã đặt
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend mb-4">
                    <div class="legend-item">
                        <div class="legend-color available"></div>
                        <span>Bàn trống - Có thể đặt</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color occupied"></div>
                        <span>Bàn đang có khách</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color reserved"></div>
                        <span>Bàn đã được đặt trước</span>
                    </div>
                </div>

                <!-- Table Grid -->
                @if (Model.Tables != null && Model.Tables.Any())
                {
                    <div class="table-grid">
                        @foreach (var table in Model.Tables)
                        {
                            var statusClass = table.TrangThai switch
                            {
                                QLy_NhaHang.Models.Enums.TableStatus.Free => "available",
                                QLy_NhaHang.Models.Enums.TableStatus.Occupied => "occupied",
                                QLy_NhaHang.Models.Enums.TableStatus.Reserved => "reserved",
                                _ => "occupied"
                            };

                            var statusText = table.TrangThai switch
                            {
                                QLy_NhaHang.Models.Enums.TableStatus.Free => "Trống",
                                QLy_NhaHang.Models.Enums.TableStatus.Occupied => "Có khách",
                                QLy_NhaHang.Models.Enums.TableStatus.Reserved => "Đã đặt",
                                _ => "Không xác định"
                            };

                            <div class="table-card @statusClass" 
                                 data-table-id="@table.Ma" 
                                 data-table-name="@table.Ten"
                                 data-available="@table.IsAvailable.ToString().ToLower()"
                                 onclick="selectTable(@table.Ma, '@table.Ten', @table.IsAvailable.ToString().ToLower())">
                                <span class="table-status-badge">@statusText</span>
                                <div class="table-number">@table.Ten</div>
                                <div class="table-info">
                                    <i class="bi bi-people-fill"></i> @table.SucChua người
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Hiện chưa có bàn nào. Vui lòng liên hệ quản lý.
                    </div>
                }

                <!-- Back Button -->
                <div class="text-center mt-5 pt-4">
                    <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-lg px-5">
                        <i class="bi bi-arrow-left me-2"></i>Quay Lại Trang Chủ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Select Table Modal -->
<div class="modal fade" id="selectTableModal" tabindex="-1" aria-labelledby="selectTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="selectTableModalLabel">
                    <i class="bi bi-table me-2"></i>Chọn Bàn Bạn Đang Ngồi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted mb-4 text-center">Vui lòng chọn bàn bạn đang ngồi để tiếp tục đặt món</p>
                
                <!-- Table Grid in Modal -->
                <div class="table-grid-modal">
                    @if (Model.Tables != null && Model.Tables.Any())
                    {
                        @foreach (var table in Model.Tables)
                        {
                            var statusClass = table.TrangThai switch
                            {
                                QLy_NhaHang.Models.Enums.TableStatus.Free => "available",
                                QLy_NhaHang.Models.Enums.TableStatus.Occupied => "occupied",
                                QLy_NhaHang.Models.Enums.TableStatus.Reserved => "reserved",
                                _ => "occupied"
                            };

                            var statusText = table.TrangThai switch
                            {
                                QLy_NhaHang.Models.Enums.TableStatus.Free => "Trống",
                                QLy_NhaHang.Models.Enums.TableStatus.Occupied => "Có khách",
                                QLy_NhaHang.Models.Enums.TableStatus.Reserved => "Đã đặt",
                                _ => "Không xác định"
                            };

                            <div class="table-card-modal @statusClass" 
                                 data-table-id="@table.Ma" 
                                 data-table-name="@table.Ten"
                                 onclick="confirmTableSelection(@table.Ma, '@table.Ten', @(table.TrangThai == QLy_NhaHang.Models.Enums.TableStatus.Occupied ? "true" : "false"))">
                                <span class="table-status-badge">@statusText</span>
                                <div class="table-number">@table.Ten</div>
                                <div class="table-info">
                                    <i class="bi bi-people-fill"></i> @table.SucChua người
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning text-center w-100">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Hiện chưa có bàn nào.
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Hủy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Menu Modal -->
<div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="menuModalLabel">
                    <i class="bi bi-menu-button-wide me-2"></i>Thực Đơn - <span id="selectedTableNameInMenu"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0 h-100">
                    <!-- Sidebar -->
                    <div class="col-md-3 col-lg-2 border-end bg-light">
                        <div class="menu-sidebar-modal p-3">
                            <h6 class="fw-bold mb-3 text-primary">
                                <i class="bi bi-list-ul me-2"></i>Danh Mục
                            </h6>
                            <nav class="menu-sidebar-nav">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <button class="btn btn-outline-primary w-100 text-start menu-category-btn active" 
                                                data-category="mon-an" onclick="loadMenuCategory('mon-an', this)">
                                            <i class="bi bi-egg-fried me-2"></i>Món Ăn
                                        </button>
                                    </li>
                                    <li class="mb-2">
                                        <button class="btn btn-outline-primary w-100 text-start menu-category-btn" 
                                                data-category="thuc-uong" onclick="loadMenuCategory('thuc-uong', this)">
                                            <i class="bi bi-cup-straw me-2"></i>Thức Uống
                                        </button>
                                    </li>
                                    <li class="mb-2">
                                        <button class="btn btn-outline-primary w-100 text-start menu-category-btn" 
                                                data-category="ruou" onclick="loadMenuCategory('ruou', this)">
                                            <i class="bi bi-wine me-2"></i>Rượu
                                        </button>
                                    </li>
                                    <li class="mb-2">
                                        <button class="btn btn-outline-success w-100 text-start menu-category-btn" 
                                                data-category="cart" onclick="loadCartView(this)">
                                            <i class="bi bi-cart-check me-2"></i>Xem Lại Các Món Đã Đặt
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                    
                    <!-- Content Area -->
                    <div class="col-md-9 col-lg-10">
                        <div class="menu-content-modal p-4" style="max-height: 600px; overflow-y: auto;">
                            <div id="menuItemsContainer">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Đang tải...</span>
                                    </div>
                                    <p class="text-muted mt-3">Đang tải thực đơn...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <div>
                        <span class="text-muted">Tổng tiền: </span>
                        <span class="fw-bold text-primary fs-5" id="totalAmount">0 đ</span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Đóng
                        </button>
                        <button type="button" class="btn btn-primary" onclick="confirmOrder()">
                            <i class="bi bi-check-circle me-2"></i>Xác Nhận Đặt Món
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bookingModalLabel">
                    <i class="bi bi-calendar-check me-2"></i>Đặt Bàn - <span id="selectedTableName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" asp-action="Create" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="tableId" name="MaBan" />

                    <!-- Tên khách hàng -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold d-flex align-items-center">
                            <i class="bi bi-person-fill text-primary me-2"></i>
                            <span>Tên khách hàng <span class="text-danger">*</span></span>
                        </label>
                        <input type="text" class="form-control form-control-lg" name="TenKhach" required 
                               placeholder="Nhập tên của bạn" />
                    </div>

                    <!-- Số điện thoại -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold d-flex align-items-center">
                            <i class="bi bi-telephone-fill text-primary me-2"></i>
                            <span>Số điện thoại <span class="text-danger">*</span></span>
                        </label>
                        <input type="tel" class="form-control form-control-lg" name="SoDienThoai" required 
                               placeholder="0123 456 789" />
                    </div>

                    <!-- Ngày và giờ đặt bàn -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold d-flex align-items-center">
                            <i class="bi bi-calendar-event-fill text-primary me-2"></i>
                            <span>Ngày và giờ đặt bàn <span class="text-danger">*</span></span>
                        </label>
                        <input type="datetime-local" class="form-control form-control-lg" name="GioDat" required 
                               min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                        <small class="form-text text-muted mt-2 d-block">
                            <i class="bi bi-info-circle me-1"></i> Vui lòng chọn thời gian sau thời điểm hiện tại
                        </small>
                    </div>

                    <!-- Số người -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold d-flex align-items-center">
                            <i class="bi bi-people-fill text-primary me-2"></i>
                            <span>Số người <span class="text-danger">*</span></span>
                        </label>
                        <input type="number" class="form-control form-control-lg" name="SoNguoi" required 
                               min="1" max="50" value="2" />
                    </div>

                    <!-- Ghi chú -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold d-flex align-items-center">
                            <i class="bi bi-chat-left-text-fill text-primary me-2"></i>
                            <span>Ghi chú (tùy chọn)</span>
                        </label>
                        <textarea class="form-control" name="GhiChu" rows="4" 
                                  placeholder="Ví dụ: Bàn gần cửa sổ, yêu cầu đặc biệt..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Hủy
                </button>
                <button type="submit" form="bookingForm" class="btn btn-primary px-4">
                    <i class="bi bi-check-circle-fill me-2"></i>Xác Nhận Đặt Bàn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content success-modal-content">
            <div class="modal-body p-0">
                <div class="success-modal-wrapper">
                    <!-- Success Icon với Animation -->
                    <div class="success-icon-wrapper">
                        <div class="success-icon-circle">
                            <i class="bi bi-check-circle-fill success-icon"></i>
                        </div>
                        <div class="success-ripple"></div>
                        <div class="success-ripple delay-1"></div>
                        <div class="success-ripple delay-2"></div>
                    </div>

                    <!-- Success Message -->
                    <h1 class="success-title-modal">Đặt Bàn Thành Công!</h1>
                    
                    <div class="success-message-box-modal" id="successMessageContent">
                        <i class="bi bi-envelope-check-fill me-2"></i>
                        <span id="successMessageText"></span>
                    </div>

                    <!-- Info Cards -->
                    <div class="info-cards-grid-modal">
                        <div class="info-card-modal">
                            <div class="info-card-icon-modal">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="info-card-content-modal">
                                <h6 class="info-card-title-modal">Xác nhận nhanh</h6>
                                <p class="info-card-text-modal">Trong vòng 30 phút</p>
                            </div>
                        </div>
                        <div class="info-card-modal">
                            <div class="info-card-icon-modal">
                                <i class="bi bi-telephone-fill"></i>
                            </div>
                            <div class="info-card-content-modal">
                                <h6 class="info-card-title-modal">Giữ máy</h6>
                                <p class="info-card-text-modal">Trả lời cuộc gọi</p>
                            </div>
                        </div>
                        <div class="info-card-modal">
                            <div class="info-card-icon-modal">
                                <i class="bi bi-pencil-square"></i>
                            </div>
                            <div class="info-card-content-modal">
                                <h6 class="info-card-title-modal">Thay đổi?</h6>
                                <p class="info-card-text-modal">Gọi: <strong>0123 456 789</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="success-actions-modal">
                        <button type="button" class="btn btn-primary btn-lg success-btn-primary-modal" onclick="closeSuccessModal()">
                            <i class="bi bi-house-fill me-2"></i>Về Trang Chủ
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-lg success-btn-secondary-modal" onclick="closeSuccessModalAndReload()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Đặt Bàn Khác
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Success Modal -->
<div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-labelledby="orderSuccessModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="orderSuccessModalLabel">
                    <i class="bi bi-check-circle-fill me-2"></i>Đặt Món Thành Công
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-5">
                <!-- Success Icon -->
                <div class="mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                </div>
                
                <!-- Title -->
                <h2 class="fw-bold mb-3" id="orderSuccessTitle">
                    Bàn <span id="orderTableName"></span> đặt món
                </h2>
                
                <!-- Subtitle -->
                <p class="lead text-muted mb-4" id="orderSuccessSubtitle">
                    Cảm ơn bạn đã gọi món. Vui lòng đợi đầu bếp làm món và phục vụ bạn.<br>
                    Cảm ơn!
                </p>
                
                <!-- Order Summary -->
                <div class="card bg-light mt-4">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-list-check me-2"></i>Tóm tắt đơn hàng
                        </h6>
                        <div id="orderSummary" class="text-start">
                            <!-- Order items will be displayed here -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Tổng tiền:</strong>
                            <strong class="text-primary fs-5" id="orderTotalAmount">0 đ</strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success btn-lg px-5" data-bs-dismiss="modal" onclick="closeOrderSuccessModal()">
                    <i class="bi bi-check-circle me-2"></i>Đã Hiểu
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Biến lưu thông tin bàn và giỏ hàng
        let selectedTableId = null;
        let selectedTableName = '';
        let cart = [];

        // Hàm xử lý khi chọn bàn từ modal "Xác nhận đúng bàn bạn ngồi"
        function confirmTableSelection(tableId, tableName, isOccupied) {
            // Đóng modal chọn bàn
            const selectTableModal = bootstrap.Modal.getInstance(document.getElementById('selectTableModal'));
            if (selectTableModal) {
                selectTableModal.hide();
            }

            // Lưu thông tin bàn
            selectedTableId = tableId;
            selectedTableName = tableName;

            // Set tên bàn trong modal thực đơn
            document.getElementById('selectedTableNameInMenu').textContent = tableName;

            // Reset giỏ hàng
            cart = [];
            updateTotalAmount();

            // Mở modal thực đơn
            const menuModalElement = document.getElementById('menuModal');
            const menuModal = new bootstrap.Modal(menuModalElement);
            
            // Load menu mặc định (Món ăn) sau khi modal đã hiển thị
            menuModalElement.addEventListener('shown.bs.modal', function() {
                loadMenuCategory('mon-an', document.querySelector('.menu-category-btn[data-category="mon-an"]'));
            }, { once: true });
            
            menuModal.show();
        }

        // Hàm load menu items theo category
        async function loadMenuCategory(category, buttonElement) {
            // Update active state của buttons
            document.querySelectorAll('.menu-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Show loading
            const container = document.getElementById('menuItemsContainer');
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="text-muted mt-3">Đang tải thực đơn...</p>
                </div>
            `;

            try {
                const response = await fetch(`@Url.Action("GetMenuItemsByCategory", "Booking")?category=${category}`);
                if (!response.ok) {
                    throw new Error('Lỗi khi tải menu');
                }
                const html = await response.text();
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading menu:', error);
                container.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Có lỗi xảy ra khi tải thực đơn. Vui lòng thử lại.
                    </div>
                `;
            }
        }

        // Hàm load giỏ hàng
        function loadCartView(buttonElement) {
            // Update active state của buttons
            document.querySelectorAll('.menu-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Render giỏ hàng
            renderCart();
        }

        // Hàm render giỏ hàng
        function renderCart() {
            const container = document.getElementById('menuItemsContainer');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="bi bi-cart-x"></i>
                        <h5 class="mt-3 text-muted">Giỏ hàng trống</h5>
                        <p class="text-muted">Vui lòng chọn món từ thực đơn</p>
                    </div>
                `;
                return;
            }

            let cartHtml = `
                <div class="cart-view">
                    <h4 class="mb-4">
                        <i class="bi bi-cart-check me-2 text-success"></i>Giỏ Hàng Của Bạn
                    </h4>
                    <div id="cartItemsList">
            `;

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                cartHtml += `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="cart-item-name mb-1">${item.name}</h6>
                                <div class="cart-item-price">${item.price.toLocaleString('vi-VN')} đ</div>
                            </div>
                            <button class="btn btn-sm btn-link text-danger remove-item-btn" onclick="removeFromCart(${index})" title="Xóa">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="quantity-input" value="${item.quantity}" 
                                   min="1" onchange="updateQuantityInput(${index}, this.value)">
                            <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                            <span class="ms-auto fw-bold text-primary">
                                = ${itemTotal.toLocaleString('vi-VN')} đ
                            </span>
                        </div>
                    </div>
                `;
            });

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartHtml += `
                    </div>
                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Tổng tiền:</h5>
                            <h4 class="mb-0 text-primary fw-bold">${total.toLocaleString('vi-VN')} đ</h4>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = cartHtml;
        }

        // Hàm xóa món khỏi giỏ hàng
        function removeFromCart(index) {
            if (confirm('Bạn có chắc muốn xóa món này khỏi giỏ hàng?')) {
                cart.splice(index, 1);
                renderCart();
                updateTotalAmount();
            }
        }

        // Hàm cập nhật số lượng
        function updateQuantity(index, change) {
            cart[index].quantity += change;
            if (cart[index].quantity < 1) {
                cart[index].quantity = 1;
            }
            renderCart();
            updateTotalAmount();
        }

        // Hàm cập nhật số lượng từ input
        function updateQuantityInput(index, value) {
            const quantity = parseInt(value) || 1;
            if (quantity < 1) {
                cart[index].quantity = 1;
            } else {
                cart[index].quantity = quantity;
            }
            renderCart();
            updateTotalAmount();
        }

        // Hàm thêm món vào giỏ hàng từ button
        function addToCartFromButton(button) {
            const itemIdStr = button.getAttribute('data-item-id');
            const itemName = button.getAttribute('data-item-name');
            const itemPriceStr = button.getAttribute('data-item-price');
            
            const itemId = parseInt(itemIdStr);
            const itemPrice = parseFloat(itemPriceStr);
            
            if (isNaN(itemId) || itemId <= 0) {
                alert('Lỗi: Không thể thêm món này vào giỏ hàng. Vui lòng thử lại.');
                return;
            }
            
            if (!itemName || itemName.trim() === '') {
                alert('Lỗi: Tên món không hợp lệ.');
                return;
            }
            
            if (isNaN(itemPrice) || itemPrice <= 0) {
                alert('Lỗi: Giá món không hợp lệ.');
                return;
            }
            
            addToCart(itemId, itemName, itemPrice);
        }

        // Hàm thêm món vào giỏ hàng
        function addToCart(itemId, itemName, itemPrice) {
            // Validate và convert dữ liệu
            const id = parseInt(itemId);
            const price = parseFloat(itemPrice);
            
            // Validate dữ liệu
            if (isNaN(id) || id <= 0) {
                alert('Lỗi: ID món không hợp lệ.');
                return;
            }
            
            if (!itemName || itemName.trim() === '') {
                alert('Lỗi: Tên món không hợp lệ.');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                alert('Lỗi: Giá món không hợp lệ.');
                return;
            }
            
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: id,
                    name: itemName,
                    price: price,
                    quantity: 1
                });
            }
            
            updateTotalAmount();
            showCartNotification();
        }

        // Hàm cập nhật tổng tiền
        function updateTotalAmount() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('totalAmount').textContent = total.toLocaleString('vi-VN') + ' đ';
        }

        // Hàm hiển thị thông báo thêm vào giỏ hàng
        function showCartNotification() {
            // Có thể thêm toast notification ở đây
        }

        // Hàm xác nhận đặt món
        async function confirmOrder() {
            if (cart.length === 0) {
                alert('Vui lòng chọn ít nhất một món!');
                return;
            }

            if (!selectedTableId) {
                alert('Vui lòng chọn bàn trước!');
                return;
            }

            // Gửi đơn hàng lên server
            await submitOrder();
        }

        // Hàm gửi đơn hàng lên server
        async function submitOrder() {
            try {
                // Lấy AntiForgeryToken từ form bookingForm
                const bookingForm = document.getElementById('bookingForm');
                const token = bookingForm ? bookingForm.querySelector('input[name="__RequestVerificationToken"]')?.value : null;
                
                if (!token) {
                    alert('Lỗi bảo mật. Vui lòng tải lại trang.');
                    return;
                }

                // Chuẩn bị dữ liệu
                const orderItems = cart.map(item => ({
                    MenuItemId: item.id,
                    Quantity: item.quantity
                }));

                // Gửi request với FormData để có AntiForgeryToken
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);
                formData.append('tableId', selectedTableId);
                formData.append('items', JSON.stringify(orderItems));

                // Gửi request
                const response = await fetch('@Url.Action("CreateOrder", "Booking")', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Lỗi khi gửi đơn hàng');
                }

                const result = await response.json();

                if (result.success) {
                    // Hiển thị thông báo thành công
                    showOrderSuccessModal();
                } else {
                    alert(result.message || 'Có lỗi xảy ra khi đặt món. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Có lỗi xảy ra khi đặt món. Vui lòng thử lại.');
            }
        }

        // Hàm hiển thị modal thông báo đặt món thành công
        function showOrderSuccessModal() {
            // Set tên bàn
            document.getElementById('orderTableName').textContent = selectedTableName;
            
            // Tính tổng tiền
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('orderTotalAmount').textContent = total.toLocaleString('vi-VN') + ' đ';
            
            // Hiển thị tóm tắt đơn hàng
            let summaryHtml = '';
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                summaryHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${item.name} x ${item.quantity}</span>
                        <span class="text-primary fw-semibold">${itemTotal.toLocaleString('vi-VN')} đ</span>
                    </div>
                `;
            });
            document.getElementById('orderSummary').innerHTML = summaryHtml;
            
            // Đóng modal thực đơn
            const menuModal = bootstrap.Modal.getInstance(document.getElementById('menuModal'));
            if (menuModal) {
                menuModal.hide();
            }
            
            // Hiển thị modal thông báo thành công
            const orderSuccessModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
            orderSuccessModal.show();
        }

        // Hàm đóng modal thông báo và reset giỏ hàng
        function closeOrderSuccessModal() {
            const orderSuccessModal = bootstrap.Modal.getInstance(document.getElementById('orderSuccessModal'));
            if (orderSuccessModal) {
                orderSuccessModal.hide();
            }
            
            // Reset giỏ hàng sau khi đặt món thành công
            cart = [];
            updateTotalAmount();
            
            // Reload trang để cập nhật trạng thái bàn
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        function selectTable(tableId, tableName, isAvailable) {
            if (!isAvailable) {
                alert('Bàn này không thể đặt được. Vui lòng chọn bàn khác (màu xanh).');
                return;
            }

            // Set table info
            document.getElementById('tableId').value = tableId;
            document.getElementById('selectedTableName').textContent = tableName;

            // Set default datetime (1 hour from now)
            const now = new Date();
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            const datetimeString = now.toISOString().slice(0, 16);
            document.querySelector('input[name="GioDat"]').value = datetimeString;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
            modal.show();
        }

        // Set min datetime for input
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.querySelector('input[type="datetime-local"]');
            if (dateInput) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                dateInput.min = now.toISOString().slice(0, 16);
            }

            // Intercept form submit
            const bookingForm = document.getElementById('bookingForm');
            const submitBtn = document.querySelector('button[form="bookingForm"][type="submit"]');
            
            // Function to handle form submission
            async function handleFormSubmit(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // Validate form first
                if (!bookingForm.checkValidity()) {
                    bookingForm.reportValidity();
                    return;
                }
                
                // Disable submit button
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';

                try {
                    // Get form data
                    const formData = new FormData(bookingForm);
                    
                    // Get AntiForgeryToken
                    const tokenInput = bookingForm.querySelector('input[name="__RequestVerificationToken"]');
                    if (!tokenInput) {
                        alert('Lỗi bảo mật. Vui lòng tải lại trang.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                    // Submit via AJAX
                    const response = await fetch('@Url.Action("Create", "Booking")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    // Check if response is OK
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        // Close booking modal
                        const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                        if (bookingModal) {
                            bookingModal.hide();
                        }

                        // Show success message
                        document.getElementById('successMessageText').textContent = result.message;
                        
                        // Show success modal
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        successModal.show();

                        // Reset form
                        bookingForm.reset();
                    } else {
                        // Show error
                        alert(result.message || 'Có lỗi xảy ra khi đặt bàn. Vui lòng thử lại.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    let errorMessage = 'Có lỗi xảy ra khi đặt bàn. Vui lòng thử lại.';
                    
                    // Try to parse error response
                    if (error.message && error.message.includes('HTTP error')) {
                        errorMessage = 'Lỗi kết nối. Vui lòng kiểm tra lại kết nối mạng và thử lại.';
                    }
                    
                    alert(errorMessage);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
            
            if (bookingForm && submitBtn) {
                // Handle form submit event
                bookingForm.addEventListener('submit', handleFormSubmit);
                
                // Also handle button click (button is outside form)
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleFormSubmit(e);
                });
            }
        });

        function closeSuccessModal() {
            const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
            if (successModal) {
                successModal.hide();
            }
            window.location.href = '@Url.Action("Index", "Home")';
        }

        function closeSuccessModalAndReload() {
            const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
            if (successModal) {
                successModal.hide();
            }
            // Reload page to update table status
            setTimeout(() => location.reload(), 300);
        }
    </script>
}

